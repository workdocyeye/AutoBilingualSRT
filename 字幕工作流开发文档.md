# 开发文档：自动化中英文字幕生成工作流

## 1. 项目概述

本项目旨在实现一个自动化的工作流，能够接收用户输入的中文文本，将其智能切分为适合字幕显示的片段，翻译成英文，并最终生成与英文朗读时长精确匹配的中英双语SRT字幕文件。核心目标是确保英文音频与字幕同步，并且中文字幕与英文字幕时间戳严格一致。

## 2. 核心技术栈

*   **大语言模型 (LLM)**: DeepSeek (或其他兼容OpenAI API的大模型)
*   **编程语言**: Python 3.x
*   **SRT处理库**: `srt` (Python library: `pip install srt`)

## 3. 工作流详解与模块设计

本工作流通过一系列协同工作的Python模块来实现。

### 3.1. 用户输入与主控模块

*   **职责**:
    *   接收用户输入的完整中文文本。
    *   启动工作流，并将任务传递给第一个处理模块。
    *   收集最终生成的中文和英文SRT文件内容，并呈现给用户或保存到文件。
*   **交互**: 作为整个流程的入口和出口。

### 3.2. 中文切分模块 (ChineseChunkerAgent)

*   **输入**: 完整的中文文本字符串。
*   **核心逻辑**:
    *   使用LLM，通过精心设计的提示 (Prompt) 指导LLM将长段中文智能切分为适合字幕显示的短句或小段落。
    *   切分时考虑语义完整性、自然停顿、每条字幕的适宜长度（避免过长或过短）、上下文连贯性。
*   **输出**: 一个包含多条中文短文本片段的列表 (e.g., `List[str]`)。

### 3.3. 翻译模块 (TranslationAgent)

*   **输入**: 由`ChineseChunkerAgent`生成的中文短文本片段列表。
*   **核心逻辑**:
    *   使用LLM，逐条将中文短文本翻译成流畅、准确的英文。
    *   强调翻译的准确性、自然度和上下文一致性。
*   **输出**: 一个与中文列表顺序一致的英文短文本片段列表 (e.g., `List[str]`)。

### 3.4. 英文SRT生成与计时模块 (EnglishSrtAgent)

*   **输入**: 由`TranslationAgent`生成的英文短文本片段列表。
*   **核心逻辑**:
    1.  **计算朗读时长**:
        *   基于预设的平均英文朗读速率，例如每分钟单词数 (WPM) 或每秒字符数 (CPS)。 (例如: 150 WPM)
        *   为每条字幕设定一个最小显示时长（如1秒）。
    2.  **生成时间戳**:
        *   根据计算出的时长，为每条英文字幕生成开始 (`HH:MM:SS,ms`) 和结束时间戳。
        *   确保字幕之间有适当的停顿（例如，200-500毫秒，此值应可配置）。
        *   第一条字幕的开始时间可以设定一个小的偏移量（例如，从视频开始后0.5秒）。
    3.  **格式化SRT文件**:
        *   使用`srt` Python库将序号、计算好的时间戳、英文文本组合成标准的SRT格式。
*   **输出**:
    *   完整的英文SRT文件内容 (字符串格式)。
    *   一个时间戳列表，每个元素为元组 `(start_time, end_time)`，供`ChineseSrtAgent`使用。 (`List[Tuple[datetime.timedelta, datetime.timedelta]]`)

### 3.5. 中文SRT生成模块 (ChineseSrtAgent)

*   **输入**:
    *   原始的中文短文本片段列表 (来自 `ChineseChunkerAgent`的输出，确保是原文)。
    *   由`EnglishSrtAgent`生成的时间戳列表。
*   **核心逻辑**:
    *   严格按照`EnglishSrtAgent`提供的时间戳列表。
    *   将这些时间戳与原始的中文短文本片段一一对应。
    *   使用`srt` Python库将序号、同步的时间戳、中文文本组合成标准的SRT格式。
*   **输出**: 完整的中文SRT文件内容 (字符串格式)。

## 4. 协调机制

*   主控脚本（main_workflow.py）负责串联各个模块，按预定顺序调用各功能模块并传递数据。
*   每个模块通过注册可执行的Python函数来完成其特定任务（如调用LLM API、处理文本、计算时间等）。

## 5. 关键配置参数

以下参数应设计为易于配置，以便优化和调整工作流效果：

*   `TARGET_WPM` (英文朗读速率，如 150)
*   `MIN_SUBTITLE_DURATION_MS` (每条字幕最小显示毫秒数，如 1000)
*   `SUBTITLE_PAUSE_MS` (字幕间的停顿毫秒数，如 200)
*   `INITIAL_OFFSET_MS` (第一条字幕的初始偏移毫秒数，如 500)
*   LLM API密钥和端点 (如DeepSeek API的相关配置)
*   Prompts文本：用于中文切分、英文翻译的提示语，建议外部化管理（如存放在单独的配置文件或模块中）。

## 6. 实现步骤建议

1.  **环境搭建**: 安装 Python, `srt`库, DeepSeek SDK (如果提供)。
2.  **配置管理**: 设置好API密钥等敏感信息。
3.  **单个模块开发与测试**:
    *   从最简单的模块开始，如`ChineseChunkerAgent`，单独测试其功能。
    *   重点调试LLM的Prompt，以达到理想的切分和翻译效果。
    *   独立测试`EnglishSrtAgent`的时间戳计算逻辑。
4.  **工作流集成**: 在主控脚本中将各个模块连接起来，构建完整的处理流程。
5.  **SRT文件输出**: 实现将最终生成的SRT字符串保存到文件的逻辑。
6.  **迭代优化**: 根据测试结果不断调整Prompt、配置参数和模块逻辑。

## 7. 错误处理与日志

*   在每个模块的关键步骤中加入try-except块来捕获和处理潜在错误（如API调用失败、数据格式错误等）。
*   使用Python的`logging`模块记录工作流的执行过程、重要数据和任何错误信息，方便调试和追踪问题。

## 8. 潜在的进一步考虑与增强

*   **人工审核环节**: 可以在关键步骤（如中文切分后、英文翻译后）设计一个暂停点，将中间结果呈现给用户进行审核和修改，然后再继续后续流程。
*   **高级文本切分**: 如果LLM在文本切分方面效果不佳，可以研究集成更专业的NLP句子分割库。
*   **音频生成集成**: 未来可以扩展此工作流，在生成英文SRT后，调用文本转语音(TTS)服务（如ElevenLabs等）生成匹配的英文朗读音频。
*   **视频处理**: 使用`ffmpeg` (可通过`ffmpeg-python`库调用) 将生成的SRT字幕文件嵌入到视频中。

## 9. 预想项目文件结构 (示例)

```
createsrt/
│
├── 字幕工作流开发文档.md  (本文档)
│
├── main_workflow.py       # 工作流启动和编排脚本
│
├── agents/                  # 各功能模块
│   ├── __init__.py
│   ├── chunker_agent.py
│   ├── translator_agent.py
│   ├── english_srt_agent.py
│   └── chinese_srt_agent.py
│
├── prompts/                 # LLM提示语
│   ├── __init__.py
│   ├── chunker_prompts.py
│   └── translator_prompts.py
│
├── utils/                   # 通用工具函数 (如时间格式化、SRT文件保存等)
│   ├── __init__.py
│   └── srt_utils.py
│
├── config.py                # 配置参数 (WPM, API密钥等)
│
├── output/                  # 生成的SRT字幕文件
│   ├── example_zh.srt
│   └── example_en.srt
│
└── requirements.txt         # Python依赖列表
```

---
